{"version":3,"sources":["../src/clients/mqtt-client.ts","../src/init.ts"],"sourcesContent":["import { ClinetInfo } from \"@tp/Connection\";\nimport { Callback, StoredSub, Subscription } from \"@tp/Subscripition\";\nimport mqtt, {\n  MqttClient as MqttJsClient,\n  IClientOptions,\n  IPublishPacket,\n  IConnackPacket,\n} from \"mqtt\";\n\n// ----- helpers -----\nfunction normalizeFilter(filter: string): string {\n  if (filter.startsWith(\"$share/\")) {\n    const parts = filter.split(\"/\");\n    if (parts.length >= 3) {\n      return parts.slice(2).join(\"/\");\n    }\n  }\n  return filter;\n}\n\nfunction isWildcardTopic(filter: string): boolean {\n  return filter.includes(\"+\") || filter.includes(\"#\");\n}\n\nfunction mqttFilterToRegex(filter: string): RegExp {\n  const real = normalizeFilter(filter);\n\n  const escaped = real\n    .split(\"/\")\n    .map((part) => {\n      if (part === \"+\") return \"[^/]+\";\n      if (part === \"#\") return \".*\";\n      return part.replace(/[-/\\\\^$*+?.()|[\\]{}]/g, \"\\\\$&\");\n    })\n    .join(\"/\");\n\n  return new RegExp(`^${escaped}$`);\n}\n\n// ----- client class -----\n\n\n/**\n * Singleton MQTT client manager\n * Handles connection, subscriptions, and message dispatching\n * \n */\nexport class MQTTClient {\n  private static instance: MQTTClient | null = null;\n  private client: MqttJsClient | null = null;\n  private clientId: string = \"\";\n\n  // exact matches: topic -> callbacks[]\n  private exactSubs = new Map<string, Callback[]>();\n\n  // wildcard matches\n  private wildcardSubs: StoredSub[] = [];\n\n  // ◊ú◊©◊ó◊ñ◊ï◊® subscriptions ◊ê◊ó◊®◊ô reconnect\n  private allSubs: StoredSub[] = [];\n\n  private connected = false;\n\n  private constructor() {}\n\n  public static getInstance(): MQTTClient {\n    if (!this.instance) {\n      this.instance = new MQTTClient();\n    }\n    return this.instance;\n  }\n\n  public isConnected(): boolean {\n    return this.connected;\n  }\n\n  public async connectAndWait(\n    {clientId, username, password, broker, port, connection_timeout=10_000}:ClinetInfo & {clientId: string}\n  ): Promise<MqttJsClient> {\n    return new Promise<MqttJsClient>((resolve, reject) => {\n      const url = `mqtts://${broker}:${port}/mqtt`;\n      const options: IClientOptions = {\n        clientId,\n        username,\n        password,\n        keepalive: 60,\n        clean: true,\n        protocolVersion: 5,\n        rejectUnauthorized: true,\n        properties: { userProperties: { client_id: clientId } },\n      };\n      this.clientId = clientId;\n\n      console.log(`Connecting to MQTT broker at ${broker}:${port}...`);\n      const client = mqtt.connect(url, options);\n      this.client = client;\n\n      const timer = setTimeout(() => {\n        client.end(true);\n        reject(new Error(`MQTT connect timeout after ${connection_timeout}ms`));\n      }, connection_timeout);\n\n      client.on(\"connect\", (packet: IConnackPacket) => {\n        clearTimeout(timer);\n        this.connected = true;\n        console.log(\"üîå MQTT connected\");\n        this.resubscribeAll();\n        resolve(client);\n      });\n\n      client.on(\"message\", (topic: string, payload: Buffer, packet: IPublishPacket) => {\n        this.dispatchMessage(topic, payload, packet);\n      });\n\n      client.on(\"reconnect\", () => {\n        console.log(\"MQTT reconnecting...\");\n      });\n\n      client.on(\"close\", () => {\n        console.log(\"MQTT connection closed\");\n        this.connected = false;\n      });\n\n      client.on(\"end\", () => {\n        console.log(\"MQTT connection ended\");\n        this.connected = false;\n      });\n\n      client.on(\"error\", (err) => {\n        console.error(\"MQTT connection error:\", err);\n        if (!this.connected) {\n          clearTimeout(timer);\n          client.end(true);\n          reject(err);\n        }\n      });\n    });\n  }\n\n\n  private dispatchMessage(topic: string, payload: Buffer, packet: IPublishPacket) {\n    // 1. exact\n    const exactCallbacks = this.exactSubs.get(topic);\n    if (exactCallbacks) {\n      for (const cb of exactCallbacks) cb(topic, payload, packet);\n    }\n\n    // 2. wildcards\n    if (this.wildcardSubs.length > 0) {\n      for (const sub of this.wildcardSubs) {\n        if (sub.regex && sub.regex.test(topic)) {\n          sub.callback(topic, payload, packet);\n        }\n      }\n    }\n  }\n\n  public addSubscribe(subscribe: Subscription): void {\n    console.log(\"Trying to subscribe to topic:\", subscribe.topic);\n\n    const filter = normalizeFilter(subscribe.topic);\n    const stored: StoredSub = {\n      originalTopic: subscribe.topic,\n      filter,\n      callback: subscribe.callback,\n      regex: undefined,\n    };\n\n    if (isWildcardTopic(filter)) {\n      stored.regex = mqttFilterToRegex(subscribe.topic);\n      this.wildcardSubs.push(stored);\n    } else {\n      const arr = this.exactSubs.get(filter) ?? [];\n      arr.push(subscribe.callback);\n      this.exactSubs.set(filter, arr);\n    }\n\n    this.allSubs.push(stored);\n\n    if (this.connected && this.client) {\n      this.client.subscribe(subscribe.topic, { qos: 0 }, (err) => {\n        if (!err) {\n          console.log(`Subscribed to topic: ${subscribe.topic}`);\n        } else {\n          console.error(`Failed to subscribe to topic: ${subscribe.topic}`, err);\n        }\n      });\n    }\n  }\n\n  private resubscribeAll(): void {\n    if (!this.client) return;\n    for (const sub of this.allSubs) {\n      this.client.subscribe(sub.originalTopic, { qos: 0 }, (err) => {\n        if (err) {\n          console.error(\"Resubscribe failed:\", sub.originalTopic, err);\n        }\n      });\n    }\n  }\n\n  public publish(\n    topic: string,\n    payload: unknown,\n    qos: 0 | 1 | 2 = 0,\n    retain = false\n  ): Promise<void> {\n    return new Promise((resolve, reject) => {\n      if (!this.client || !this.connected) {\n        return reject(new Error(\"MQTT client not connected\"));\n      }\n      const data =\n        typeof payload === \"string\" || Buffer.isBuffer(payload)\n          ? payload\n          : JSON.stringify(payload);\n\n      this.client.publish(\n        topic,\n        data,\n        {\n          qos,\n          retain,\n          properties: this.clientId\n            ? { userProperties: { client_id: this.clientId } }\n            : undefined,\n        },\n        (err) => (err ? reject(err) : resolve())\n      );\n    });\n  }\n}\n","import { ClinetInfo } from \"@tp/Connection\";\nimport { MQTTClient } from \"./clients/mqtt-client\";\nimport { SubCB, Subscription } from \"@tp/Subscripition\";\nimport { v4 as uuidv4 } from 'uuid';\n/**\n * \n * @param clientInfo client info that you got from street-piano\n * @param piano_id the specific piano id you got\n * @param cb callback function when a new message is comming\n * @param shared if you want to use shared subscription you can run multipule clients with the same consumer group\n * @param consumer_group this reqiures when shared to be true, the name of the consumer group\n */\nexport async function initializeClient(clientInfo:ClinetInfo,piano_id:string, cb:SubCB, shared?:boolean, consumer_group?: string ): Promise<void> {\n    if(!piano_id){\n        throw new Error(\"Piano ID is required to initialize the MQTT client.\");\n    }\n     const mqttClient = MQTTClient.getInstance();\n     const subscribation:Subscription = buildSubscribation(piano_id, cb, shared, consumer_group);\n     mqttClient.addSubscribe(subscribation);\n\n      await mqttClient.connectAndWait({...clientInfo, clientId: uniqueClient(piano_id) });\n}\n\nconst uniqueClient = (piano_id:string)=>{\n    const uuid = uuidv4();\n    return `${piano_id}_${uuid}`;\n}\n\nconst buildSubscribation = (piano_id:string, cb:SubCB, shared?:boolean, consumer_group?: string):Subscription => {\n    if(shared && consumer_group){\n        return {\n            topic: `$share/${consumer_group}/piano/play/${piano_id}`,\n            callback: cb\n        }\n    } else {\n        return {\n            topic: `piano/play/${piano_id}`,\n            callback: cb\n        }\n    }\n\n}\n"],"mappings":"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","names":[]}